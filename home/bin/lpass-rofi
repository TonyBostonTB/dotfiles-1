#!/bin/bash

export EDITOR="$TERMINAL -e nvim"

print-account-list() {
  lpass ls --format "%/as%ag - %an (%au) [%ai]" 2>&1
}

edit-account() {
  lpass edit "$1" $2
}

copy-account-field() {
  lpass show --clip "--${2}" "$1" >/dev/null 2>/dev/null
}

open-account-url() {
  local url
  url="$(lpass show --url "$1")"
  if [[ -n $url ]]; then
    xdg-open "$url" >/dev/null 2>/dev/null
  else
    exit 2
  fi
}

is-actual-url() {
  local url="$1"
  if [[ -n $url && "$url" != " " && "$url" != "http://" && "$url" != "https://" ]]; then
    return 0
  else
    return 1
  fi
}

show-account-options() {
  local id="$1"

  echo ">> Copy password"
  echo ">> Copy username"
  echo ">> Edit"
  echo ">> Edit notes"

  url=$(lpass show --url "$id")
  if is-actual-url "$url"; then
    echo ">> Open $url"
    echo ">> Copy URL"
  fi

  echo ">> Copy ID"
}

is-entry-selected() {
  if [[ -n "$*" ]]; then
    return 0
  else
    return 1
  fi
}

id-in-selection() {
  echo "$1" | grep -oE '\[[0-9]+\]$' | tr -d '[]'
}

name-in-selection() {
  echo -e "$1" | head -1
}

debug() {
  echo "$@" > /dev/stderr
}

main() {
  local MORE_FLAGS=(-dmenu -i --no-custom -p "LastPass" -markup)
  MORE_FLAGS+=(-kb-custom-1 "Ctrl-c" -kb-custom-2 "Ctrl-x" -kb-custom-3 "Ctrl-E" -kb-custom-4 "Alt-E")
  MORE_FLAGS+=(-u 2,3 -a 4,5 )
  local MESG
  status="$(lpass status)"
  MESG="""<i>${status}</i>

You can see more options for a selection by hitting <b>Enter</b>.
<b>Ctrl-c</b> to copy the password.
<b>Ctrl-x</b> to copy the username.
<b>Ctrl-shift-e</b> to edit the entry.
<b>Alt-shift-e</b> to edit notes.
<b>Escape</b> to cancel
"""
  RES=$(print-account-list | rofi "${MORE_FLAGS[@]}" -cycle -mesg "${MESG}")
  RTR=$?
  id="$(id-in-selection "$RES")"
  if [ ${RTR} = 10 ]; then
    copy-account-field "$id" password
    return 0
  elif [ ${RTR} = 11 ]; then
    copy-account-field "$id" username
    return 0
  elif [ ${RTR} = 12 ]; then
    edit-account "$id"
    return 0
  elif [ ${RTR} = 13 ]; then
    edit-account "$id" --notes
    return 0
  elif [ ${RTR} = 1 ]; then
    return 1
  else
    MESG="""<i>${status}</i>

Options for account:
    <b>$(name-in-selection "$RES")</b>"""

    RES=$(show-account-options "$id" | rofi "${MORE_FLAGS[@]}" -cycle -mesg "${MESG}")
    RTR=$?
    if [ ${RTR} = 0 ]; then
      case "$RES" in
        '>> Copy password')
          copy-account-field "$id" password ;;
        '>> Copy username')
          copy-account-field "$id" username ;;
        '>> Edit')
          edit-account "$id" ;;
        '>> Edit notes')
          edit-account "$id" --notes ;;
        '>> Copy URL')
          copy-account-field "$id" url ;;
        '>> Copy ID')
          copy-account-field "$id" id ;;
        '>> Open')
          open-account-url "$id" ;;
      esac

      return 0
    else
      return $RTR
    fi
  fi
}

main "$@"
